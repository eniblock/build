stages:
  - publish

image:
  name: $CI_REGISTRY_IMAGE/docker:gle-it-136-fix-docker-rate-limit
  entrypoint: ["/entrypoint.sh"]


docker:
  stage: publish
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - build $CI_REGISTRY_IMAGE/docker docker
  only:
    changes:
      - .gitlab-ci.yml
      - docker/**/*
      - docker/*

helm:
  stage: publish
  script:
    - TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
    - 'curl --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest'
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - build $CI_REGISTRY_IMAGE/helm helm
  only:
    changes:
      - .gitlab-ci.yml
      - helm/**/*
      - helm/*

deploy:
  stage: publish
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - build $CI_REGISTRY_IMAGE/deploy deploy
  only:
    changes:
      - .gitlab-ci.yml
      - deploy/**/*
      - deploy/*
