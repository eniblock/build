#!/bin/bash

set -e

image=$1
helmdir=$2
patch_values=$3

name=`yq eval .name $helmdir/Chart.yaml`
version=`yq eval .version $helmdir/Chart.yaml`
if [ -z "$CI_COMMIT_TAG" ]; then
  version=$version-$CI_COMMIT_REF_SLUG
else
  if [ "$version" != "$CI_COMMIT_TAG" ]; then
    echo Chart version and tag mismatch: "$version" vs "$CI_COMMIT_TAG" >> /dev/stderr
    exit 1
  fi
fi

if [ -z "$CI_COMMIT_TAG" ]; then
  appVersion=$version.$CI_PIPELINE_IID
else
  appVersion=$version
fi

# copy the Chart in the safe place
tmp_chart=`mktemp`
cp $helmdir/Chart.yaml $tmp_chart
tmp_values=`mktemp`
cp $helmdir/values.yaml $tmp_values

yq e -i ".version = \"$appVersion\"" $helmdir/Chart.yaml
if [[ "$patch_values" != *"NO_PATCH"* ]]; then
  yq e -i ".appVersion = \"$appVersion\"" $helmdir/Chart.yaml
fi
for path in $patch_values; do
  if [ "$path" != "NO_PATCH" ]; then
    yq e -i "$path = \"$appVersion\"" $helmdir/values.yaml
  fi
done

helm package --version $version ./$helmdir
helm push ${name}-${version}.tgz oci://$image:$version

if [ -z "$CI_COMMIT_TAG" ]; then
  version=$version.$CI_PIPELINE_IID
  helm package --version $version ./$helmdir
  helm push ${name}-${version}.tgz oci://$image:$version
fi

cp $tmp_chart $helmdir/Chart.yaml
cp $tmp_values $helmdir/values.yaml
