#!/bin/bash

set -ex

image=$1
context=${2:-.}
dockerfile=${3:-$context}

if [ -z "$CI_COMMIT_TAG" ]; then
  version=$CI_COMMIT_REF_SLUG
  images=$image:$version,$image:$version.$CI_PIPELINE_IID
else
  images=$image:$CI_COMMIT_TAG
fi
if [ "$BUILD_CACHE" == "true" ]; then
  cache_opt="--import-cache type=registry,ref=$image:build-cache"
fi
buildctl-daemonless.sh build \
  --frontend dockerfile.v0 \
  --local context=$context \
  --local dockerfile=$dockerfile \
  --export-cache mode=max,type=registry,ref=$image:build-cache,push=true \
  --secret id=gitlabToken,env=CI_JOB_TOKEN \
  $cache_opt \
  --output type=image,\"name=$images\",push=true \
  "${@:4}"
